<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>rabbitmq入门 | APRICITY</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="个人知识库">
    
    <link rel="preload" href="/personal_wiki/assets/css/0.styles.65ccb39f.css" as="style"><link rel="preload" href="/personal_wiki/assets/js/app.d60e7411.js" as="script"><link rel="preload" href="/personal_wiki/assets/js/2.487a0e24.js" as="script"><link rel="preload" href="/personal_wiki/assets/js/15.cbdbc27a.js" as="script"><link rel="prefetch" href="/personal_wiki/assets/js/10.83cc57ab.js"><link rel="prefetch" href="/personal_wiki/assets/js/11.342c6dde.js"><link rel="prefetch" href="/personal_wiki/assets/js/12.fb7b3bce.js"><link rel="prefetch" href="/personal_wiki/assets/js/13.ad4f0c53.js"><link rel="prefetch" href="/personal_wiki/assets/js/14.1e7cab5b.js"><link rel="prefetch" href="/personal_wiki/assets/js/16.1ba1c252.js"><link rel="prefetch" href="/personal_wiki/assets/js/17.88091353.js"><link rel="prefetch" href="/personal_wiki/assets/js/18.3285ccaa.js"><link rel="prefetch" href="/personal_wiki/assets/js/19.9da75aa9.js"><link rel="prefetch" href="/personal_wiki/assets/js/20.f2217f22.js"><link rel="prefetch" href="/personal_wiki/assets/js/3.131c70a8.js"><link rel="prefetch" href="/personal_wiki/assets/js/4.b5c5d85a.js"><link rel="prefetch" href="/personal_wiki/assets/js/5.aedbb9bc.js"><link rel="prefetch" href="/personal_wiki/assets/js/6.7dd3e1f3.js"><link rel="prefetch" href="/personal_wiki/assets/js/7.c597da36.js"><link rel="prefetch" href="/personal_wiki/assets/js/8.518a8b15.js"><link rel="prefetch" href="/personal_wiki/assets/js/9.8d4d5d94.js">
    <link rel="stylesheet" href="/personal_wiki/assets/css/0.styles.65ccb39f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/personal_wiki/" class="home-link router-link-active"><!----> <span class="site-name">APRICITY</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="读书笔记" class="dropdown-title"><span class="title">读书笔记</span> <span class="arrow down"></span></button> <button type="button" aria-label="读书笔记" class="mobile-dropdown-title"><span class="title">读书笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/personal_wiki/book/rabbitmq-in-action-guide/" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  rabbitmq实战指南
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="课程笔记" class="dropdown-title"><span class="title">课程笔记</span> <span class="arrow down"></span></button> <button type="button" aria-label="课程笔记" class="mobile-dropdown-title"><span class="title">课程笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/personal_wiki/course/ci-cd/" class="nav-link">
  CI/CD
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="工具" class="dropdown-title"><span class="title">工具</span> <span class="arrow down"></span></button> <button type="button" aria-label="工具" class="mobile-dropdown-title"><span class="title">工具</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/personal_wiki/tools/vagrant/get_startting.html" class="nav-link">
  vagrant
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="读书笔记" class="dropdown-title"><span class="title">读书笔记</span> <span class="arrow down"></span></button> <button type="button" aria-label="读书笔记" class="mobile-dropdown-title"><span class="title">读书笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/personal_wiki/book/rabbitmq-in-action-guide/" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  rabbitmq实战指南
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="课程笔记" class="dropdown-title"><span class="title">课程笔记</span> <span class="arrow down"></span></button> <button type="button" aria-label="课程笔记" class="mobile-dropdown-title"><span class="title">课程笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/personal_wiki/course/ci-cd/" class="nav-link">
  CI/CD
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="工具" class="dropdown-title"><span class="title">工具</span> <span class="arrow down"></span></button> <button type="button" aria-label="工具" class="mobile-dropdown-title"><span class="title">工具</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/personal_wiki/tools/vagrant/get_startting.html" class="nav-link">
  vagrant
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/personal_wiki/book/rabbitmq-in-action-guide/" aria-current="page" class="active sidebar-link">rabbitmq入门</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/personal_wiki/book/rabbitmq-in-action-guide/#第一章-消息中间件的作用" class="sidebar-link">第一章 消息中间件的作用</a></li><li class="sidebar-sub-header"><a href="/personal_wiki/book/rabbitmq-in-action-guide/#第二章-入门" class="sidebar-link">第二章 入门</a></li></ul></li><li><a href="/personal_wiki/book/rabbitmq-in-action-guide/03_客户端开发向导.html" class="sidebar-link">第三章 客户端开发向导</a></li><li><a href="/personal_wiki/book/rabbitmq-in-action-guide/04_RabbitMQ进阶.html" class="sidebar-link">第四章 RabbitMQ进阶</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="rabbitmq入门"><a href="#rabbitmq入门" class="header-anchor">#</a> rabbitmq入门</h1> <h2 id="第一章-消息中间件的作用"><a href="#第一章-消息中间件的作用" class="header-anchor">#</a> 第一章 消息中间件的作用</h2> <ul><li>解耦：约定消息格式相当于约定协议，系统之间可以自定义消息/协议处理</li> <li>存储：可以持久化消息，保证消息数据正确使用</li> <li>削峰填谷：防止访问量剧增拖垮系统</li> <li>顺序保证：大部分消息中间件支持一定程度上的顺序性</li> <li>异步通信</li></ul> <h3 id="安装"><a href="#安装" class="header-anchor">#</a> 安装</h3> <p><a href="https://www.rabbitmq.com/download.html" target="_blank" rel="noopener noreferrer">官方文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a><br>
Web控制台地址: 127.0.0.1:15672<br>
默认账户密码 guest/guest</p> <p>默认账户远程访问受限，需要添加用户</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># 创建用户 用户名root  密码root</span>
rabbitmqctl add_user root root
<span class="token comment"># 为用户设置所有权限</span>
rabbitmqctl add_user set_permission -p / root <span class="token string">&quot;.*&quot;</span> <span class="token string">&quot;.*&quot;</span> <span class="token string">&quot;.*&quot;</span>
<span class="token comment"># 设置用户为管理员角色</span>
rabbitmqctl set_user_tags root administrator
</code></pre></div><h2 id="第二章-入门"><a href="#第二章-入门" class="header-anchor">#</a> 第二章 入门</h2> <h3 id="producer-生产者"><a href="#producer-生产者" class="header-anchor">#</a> Producer 生产者</h3> <p>生产者创建消息，然后发布到RabbitMQ中。消息一般可以包含2个部分:消息体和标签
(Label)。 消息体也可以称之为payload， 在实际应用中，消息体一般是一个带有业务逻辑结构
的数据，比如一个JSON字符串。当然可以进一步对这个消息体进行序列化操作。消息的标签用来表述这条消息，比如一个交换器的名称和一个路由键。生产者把消息交由RabbitMQ,
RabbitMQ之后会根据标签把消息发送给感兴趣的消费者(Consumer)。</p> <h3 id="consumer-消费者"><a href="#consumer-消费者" class="header-anchor">#</a> Consumer 消费者</h3> <p>消费者连接到RabbitMQ服务器，并订阅到队列上。当消费者消费一条消息时， 只是消费
消息的消息体(payload)。 在消息路由的过程中，消息的标签会丢弃，存入到队列中的消息只
有消息体，消费者也只会消费到消息体，也就不知道消息的生产者是谁，当然消费者也不需要知道。</p> <h3 id="broker-服务节点"><a href="#broker-服务节点" class="header-anchor">#</a> Broker 服务节点</h3> <p>对于RabbitMQ来说，一个RabbitMQ Broker 可以简单看做一个RabbitMQ服务节点，
或者RabbitMQ服务实例。大多数情况下也可以将一个RabbitMQ Broker 看作一台RabbitMQ服务器</p> <h4 id="消息生产-消费流程"><a href="#消息生产-消费流程" class="header-anchor">#</a> 消息生产-消费流程</h4> <ol><li>生产者包装消息，然后发送消息(<code>basic.publish</code>)到Broker中。</li> <li>消费者订阅并接收消息(<code>basic.cusume</code>或者<code>basic.get</code>)，经过处理得到原始数据</li> <li>进行业务逻辑处理
业务逻辑与接收消息逻辑不需要使用同一个线程。消费者可以使用一个线程接收消息并存入内存中，比如<code>BlockingQueue</code>。业务处理逻辑
使用另一个线程从内存中读取</li></ol> <h3 id="队列"><a href="#队列" class="header-anchor">#</a> 队列</h3> <ol><li><code>Queue</code>：队列，<code>RabbitMQ</code>的内部对象，用于存储消息</li> <li>多个消费者可以订阅同一个队列,这时队列中的消息会被平均分摊(<code>Round-Robin</code>,即轮询)
给多个消费者进行处理，而不是每个消费者都收到所有的消息并处理。
例如：A与B消费同意队列，A消费消息1后，B就会消费消息2，不会消费同一消息</li></ol> <h3 id="交换器、路由、绑定"><a href="#交换器、路由、绑定" class="header-anchor">#</a> 交换器、路由、绑定</h3> <ul><li><p><code>Exchange</code>：交换器</p> <p>生产者发送消息给<code>Exchange</code>，<code>Exchange</code>将消息路由到一个或多个队列中，如果路由不到则返回给生产者或直接丢弃</p></li> <li><p>交换器有四种类型，具有不同策略</p></li> <li><p><code>RoutingKey</code>：</p> <p>生产者将消息发送给交换器的时候，一般会指定一个<code>RoutingKey</code>，用来指定这个消息的路由规则，而这个<code>RoutingKey</code>需要与交换器类型和绑定键(<code>BindingKey</code>)联合使用才会生效
在交换器和绑定键(<code>BingdingKey</code>)固定的情况下，生产者可以在发送消息给交换器时，通过指定<code>RoutingKey</code>来决定消息流向哪里</p></li> <li><p><code>Binding</code>：绑定。</p> <p><code>RabbitMQ</code>中通过绑定将交换器与队列关联，在绑定的时候通常会指定绑定键(<code>BindingKey</code>)，这样<code>RabbitMQ</code>就知道如何正确地将消息路由到队列了</p> <p>生产者将消息发送给交换器时，需要一个<code>RoutingKey</code>，当<code>BindingKey</code>和<code>RoutingKey</code>相匹配时，消息会被路由到对应的队列中。在绑定多个队列到同一个交换器的时候，这些绑定允许使用相同的<code>BindingKey</code>。B<code>indingKey</code>并不是在所有的情况下都生效，它依赖于交换器类型，比如fanout类型的交换器就会无视<code>BindingKey</code>，而是将消息路由到所有绑定到该交换器的队列中。</p> <ul><li>在使用绑定的时候，其中需要的路由键是<code>BindingKey</code>。 涉及的客户端方法如:
<code>channel.exchangeBind</code>、<code>channel.queueBind</code>,对应的AMQP命令为<code>Exchange.Bind</code>、<code>Queue.Bind</code>.</li> <li>在发送消息的时候，其中需要的路由键是<code>RoutingKey</code>。 涉及的客户端方法如
<code>channel.basicPublish</code>,对应的AMQP命令为<code>Basic.Publish</code>。</li></ul></li></ul> <h4 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h4> <ol><li>生产者生产消息</li> <li>根据<code>RoutingKey</code>将消息发送给对应的<code>Exchange</code></li> <li><code>Exchange</code>有四种不同类型，不同类型的<code>Exchange</code>根据自己的<code>RoutingKey</code>规则将消息发送给对应的队列</li> <li>消费者从队列消费消息</li> <li>路由消息叫<code>RoutingKey</code>，路由与队列绑定叫<code>BindingKey</code></li></ol> <h3 id="交换器类型"><a href="#交换器类型" class="header-anchor">#</a> 交换器类型</h3> <p>RabbitMQ常用的交换器类型有fanout、direct、topic、headers这四种</p> <h4 id="fanout"><a href="#fanout" class="header-anchor">#</a> fanout</h4> <p>它会把所有发送到该交换器的消息<strong>路由到所有与该交换器绑定的队列中</strong>。</p> <h4 id="direct"><a href="#direct" class="header-anchor">#</a> direct</h4> <p>它会把消息<strong>路由到那些<code>BindingKey</code>和<code>RoutingKey</code>完全匹配的队列中</strong>。</p> <h4 id="topic"><a href="#topic" class="header-anchor">#</a> topic</h4> <p>它会把消息路由到那些符合<code>BindingKey</code>和<code>RoutingKey</code><strong>匹配规则</strong>的队列中。</p> <p>规则：</p> <ul><li><code>RoutingKey</code>为一个点号<code>.</code>分隔的字符串（被点号<code>.</code>分隔开的每一段独立的字符串称为一个单词）,如<code>com.rabbitmq.client</code>、<code>java.util.concurrent</code>、<code>com.hidden.client</code></li> <li><code>BindingKey</code>和<code>RoutingKey</code>一样也是点号<code>.</code>分隔的字符串</li> <li><code>BindingKey</code>中可以存在两种特殊字符串<code>*</code>和<code>＃</code>，用于做模糊匹配，其中<code>＃</code>用于匹配一个单词，<code>*</code>用于匹配多规格单词（可以是零个）</li></ul> <p>例子：</p> <p><img src="/book/rabbitmq-in-action-guide/rabbitmq-topic.svg" alt=""></p> <ul><li><p>路由键为<code>com.rabbitmq.client</code>的消息会同时路由到Queue1和Queue2；</p></li> <li><p>路由键为<code>com.hidden.client</code>的消息只会路由到Queue2中；</p></li> <li><p>路由键为<code>java.rabbitmq.demo</code>的消息只会路由到Queue1中；</p></li> <li><p>路由键为<code>java.util.concurrent</code>的消息将会被丢弃或者返回给生产者</p></li></ul> <h4 id="headers"><a href="#headers" class="header-anchor">#</a> headers</h4> <p>headers类型的交换器不依赖于路由键的匹配规则来路由消息，而是根据发送的消息内容中的headers属性进行匹配。在绑定队列和交换器时制定一组键值对，当发送消息到交换器时，RabbitMQ会获取到该消息的headers（也是一个键值对的形式），对比其中的键值对是否完全匹配队列和交换器绑定时指定的键值对，如果完全匹配则消息会路由到该队列，否则不会路由到该队列。<strong>headers类型的交换器性能会很差，而且也不实用，基本上不会看到它的存在。</strong></p> <h3 id="运转流程总结"><a href="#运转流程总结" class="header-anchor">#</a> 运转流程总结</h3> <p>了解了以上的RabbitMQ架构模型及相关术语，再来回顾整个消息队列的使用过程。在最初状态下，生产者发送消息的时候：</p> <ol><li>生产者连接到RabbitMQ Broker，建立一个连接（Connection），开启一个信道（Channel）（详细内容请参考3.1节）。</li> <li>生产者声明一个交换器，并设置相关属性，比如交换机类型、是否持久化等（详细内容请参考3.2节）。</li> <li>生产者声明一个队列并设置相关属性，比如是否排他、是否持久化、是否自动删除等（详细内容请参考3.2节）。</li> <li>生产者通过路由键将交换器和队列绑定起来（详细内容请参考3.2节）。</li> <li>生产者发送消息至RabbitMQ Broker，其中包含路由键、交换器等信息（详细内容请参考3.3节）。</li> <li>相应的交换器根据接收到的路由键查找相匹配的队列。</li> <li>如果找到，则将从生产者发送过来的消息存入相应的队列中。</li> <li>如果没有找到，则根据生产者配置的属性选择丢弃还是回退给生产者（详细内容请参考4.1节）。</li> <li>关闭信道。</li> <li>关闭连接。</li></ol> <p>消费者接收消息的过程：</p> <ol><li>消费者连接到RabbitMQ Broker，建立一个连接（Connection），开启一个信道（Channel）。</li> <li>消费者向RabbitMQ Broker请求消费相应队列中的消息，可能会设置相应的回调函数，以及做一些准备工作（详细内容请参考3.4节）。</li> <li>等待RabbitMQ Broker回应并投递相应队列中的消息，消费者接收消息。</li> <li>消费者确认（ack）接收到的消息。</li> <li>RabbitMQ从队列中删除相应已经被确认的消息。</li> <li>关闭信道。</li> <li>关闭连接。</li></ol> <h4 id="信道与连接"><a href="#信道与连接" class="header-anchor">#</a> 信道与连接</h4> <p>无论是生产者还是消费者，都需要和RabbitMQ Broker建立连接，这个连接就是一条TCP连接，也就是Connection。一旦TCP连接建立起来，客户端紧接着可以创建一个AMQP信道（Channel），每个信道都会被指派一个唯一的ID。信道是建立在Connection之上的虚拟连接，RabbitMQ处理的每条AMQP指令都是通过信道完成的。</p> <p>RabbitMQ采用类似NIO（Non-blocking I/O）的做法，选择TCP连接复用，不仅可以减少性能开销，同时也便于管理。</p> <p>每个线程把持一个信道，所以信道复用了Connection的TCP连接。同时RabbitMQ可以确保每个线程的私密性，就像拥有独立的连接一样。当每个信道的流量不是很大时，复用单一的Connection可以在产生性能瓶颈的情况下有效地节省TCP连接资源。<strong>但是当信道本身的流量很大时，这时候多个信道复用一个Connection就会产生性能瓶颈，进而使整体的流量被限制了。此时就需要开辟多个Connection，将这些信道均摊到这些Connection中。</strong></p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><!----> <span class="next"><a href="/personal_wiki/book/rabbitmq-in-action-guide/03_客户端开发向导.html">
        第三章 客户端开发向导
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/personal_wiki/assets/js/app.d60e7411.js" defer></script><script src="/personal_wiki/assets/js/2.487a0e24.js" defer></script><script src="/personal_wiki/assets/js/15.cbdbc27a.js" defer></script>
  </body>
</html>
