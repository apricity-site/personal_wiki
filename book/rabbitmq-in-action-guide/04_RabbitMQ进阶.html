<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>第四章 RabbitMQ进阶 | APRICITY</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="个人知识库">
    
    <link rel="preload" href="/personal_wiki/assets/css/0.styles.65ccb39f.css" as="style"><link rel="preload" href="/personal_wiki/assets/js/app.d60e7411.js" as="script"><link rel="preload" href="/personal_wiki/assets/js/2.487a0e24.js" as="script"><link rel="preload" href="/personal_wiki/assets/js/14.1e7cab5b.js" as="script"><link rel="prefetch" href="/personal_wiki/assets/js/10.83cc57ab.js"><link rel="prefetch" href="/personal_wiki/assets/js/11.342c6dde.js"><link rel="prefetch" href="/personal_wiki/assets/js/12.fb7b3bce.js"><link rel="prefetch" href="/personal_wiki/assets/js/13.ad4f0c53.js"><link rel="prefetch" href="/personal_wiki/assets/js/15.cbdbc27a.js"><link rel="prefetch" href="/personal_wiki/assets/js/16.1ba1c252.js"><link rel="prefetch" href="/personal_wiki/assets/js/17.88091353.js"><link rel="prefetch" href="/personal_wiki/assets/js/18.3285ccaa.js"><link rel="prefetch" href="/personal_wiki/assets/js/19.9da75aa9.js"><link rel="prefetch" href="/personal_wiki/assets/js/20.f2217f22.js"><link rel="prefetch" href="/personal_wiki/assets/js/3.131c70a8.js"><link rel="prefetch" href="/personal_wiki/assets/js/4.b5c5d85a.js"><link rel="prefetch" href="/personal_wiki/assets/js/5.aedbb9bc.js"><link rel="prefetch" href="/personal_wiki/assets/js/6.7dd3e1f3.js"><link rel="prefetch" href="/personal_wiki/assets/js/7.c597da36.js"><link rel="prefetch" href="/personal_wiki/assets/js/8.518a8b15.js"><link rel="prefetch" href="/personal_wiki/assets/js/9.8d4d5d94.js">
    <link rel="stylesheet" href="/personal_wiki/assets/css/0.styles.65ccb39f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/personal_wiki/" class="home-link router-link-active"><!----> <span class="site-name">APRICITY</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="读书笔记" class="dropdown-title"><span class="title">读书笔记</span> <span class="arrow down"></span></button> <button type="button" aria-label="读书笔记" class="mobile-dropdown-title"><span class="title">读书笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/personal_wiki/book/rabbitmq-in-action-guide/" class="nav-link router-link-active">
  rabbitmq实战指南
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="课程笔记" class="dropdown-title"><span class="title">课程笔记</span> <span class="arrow down"></span></button> <button type="button" aria-label="课程笔记" class="mobile-dropdown-title"><span class="title">课程笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/personal_wiki/course/ci-cd/" class="nav-link">
  CI/CD
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="工具" class="dropdown-title"><span class="title">工具</span> <span class="arrow down"></span></button> <button type="button" aria-label="工具" class="mobile-dropdown-title"><span class="title">工具</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/personal_wiki/tools/vagrant/get_startting.html" class="nav-link">
  vagrant
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="读书笔记" class="dropdown-title"><span class="title">读书笔记</span> <span class="arrow down"></span></button> <button type="button" aria-label="读书笔记" class="mobile-dropdown-title"><span class="title">读书笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/personal_wiki/book/rabbitmq-in-action-guide/" class="nav-link router-link-active">
  rabbitmq实战指南
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="课程笔记" class="dropdown-title"><span class="title">课程笔记</span> <span class="arrow down"></span></button> <button type="button" aria-label="课程笔记" class="mobile-dropdown-title"><span class="title">课程笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/personal_wiki/course/ci-cd/" class="nav-link">
  CI/CD
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="工具" class="dropdown-title"><span class="title">工具</span> <span class="arrow down"></span></button> <button type="button" aria-label="工具" class="mobile-dropdown-title"><span class="title">工具</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/personal_wiki/tools/vagrant/get_startting.html" class="nav-link">
  vagrant
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/personal_wiki/book/rabbitmq-in-action-guide/" aria-current="page" class="sidebar-link">rabbitmq入门</a></li><li><a href="/personal_wiki/book/rabbitmq-in-action-guide/03_客户端开发向导.html" class="sidebar-link">第三章 客户端开发向导</a></li><li><a href="/personal_wiki/book/rabbitmq-in-action-guide/04_RabbitMQ进阶.html" class="active sidebar-link">第四章 RabbitMQ进阶</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/personal_wiki/book/rabbitmq-in-action-guide/04_RabbitMQ进阶.html#basicpublish" class="sidebar-link">basicPublish</a></li><li class="sidebar-sub-header"><a href="/personal_wiki/book/rabbitmq-in-action-guide/04_RabbitMQ进阶.html#备份交换器" class="sidebar-link">备份交换器</a></li></ul></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="第四章-rabbitmq进阶"><a href="#第四章-rabbitmq进阶" class="header-anchor">#</a> 第四章 RabbitMQ进阶</h1> <h2 id="basicpublish"><a href="#basicpublish" class="header-anchor">#</a> <code>basicPublish</code></h2> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">void</span> <span class="token function">basicPublish</span><span class="token punctuation">(</span><span class="token class-name">String</span> exchange<span class="token punctuation">,</span> <span class="token class-name">String</span> routingKey<span class="token punctuation">,</span> <span class="token keyword">boolean</span> mandatory<span class="token punctuation">,</span> <span class="token keyword">boolean</span> immediate<span class="token punctuation">,</span> <span class="token class-name">BasicProperties</span> props<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> body<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">;</span>
</code></pre></div><p>mandatory和immediate都有当消息传递过程中不可达目的地时将消息返回给生产者的功能。</p> <p>RabbitMQ提供的备份交换器（Alternate Exchange）可以将未能被交换器路由的消息（没有绑定队列或者没有匹配的绑定）存储起来，而不用返回给客户端。</p> <h3 id="mandatory"><a href="#mandatory" class="header-anchor">#</a> <code>mandatory</code></h3> <p>当mandatory参数设为true时，交换器无法根据自身的类型和路由键找到一个符合条件的队列，那么RabbitMQ会调用Basic.Return命令将消息返回给生产者。当mandatory参数设置为false时，出现上述情形，则消息直接被丢弃。</p> <p>通过调用channel.addReturnListener来添加<strong>ReturnListener</strong>监听器,生产者可以获取到没有被正确路由到合适队列的消息</p> <h3 id="immediate"><a href="#immediate" class="header-anchor">#</a> <code>immediate</code></h3> <p>当immediate参数设为true时，如果交换器在将消息路由到队列时发现队列上并不存在任何消费者，那么这条消息将不会存入队列中。当与路由键匹配的所有队列都没有消费者时，该消息会通过Basic.Return返回至生产者。</p> <p><strong>概括来说，mandatory参数告诉服务器至少将该消息路由到一个队列中，否则将消息返回给生产者。immediate参数告诉服务器，如果该消息关联的队列上有消费者，则立刻投递；如果所有匹配的队列上都没有消费者，则直接将消息返还给生产者，不用将消息存入队列而等待消费者了。</strong>
RabbitMQ 3.0版本开始去掉了对immediate参数的支持，对此RabbitMQ官方解释是：immediate参数会影响镜像队列的性能，增加了代码复杂性，建议采用TTL和DLX的方法替代。（有关TTL和DLX的介绍请分别参考4.2节和4.3节。）</p> <h2 id="备份交换器"><a href="#备份交换器" class="header-anchor">#</a> 备份交换器</h2> <p>备份交换器，英文名称为Alternate Exchange，简称AE</p> <p>生产者在发送消息的时候如果不设置mandatory参数，那么消息在未被路由的情况下将会丢失；如果设置了mandatory参数，那么需要添加ReturnListener的编程逻辑，生产者的代码将变得复杂。<strong>如果既不想复杂化生产者的编程逻辑，又不想消息丢失，那么可以使用备份交换器，这样可以将未被路由的消息存储在RabbitMQ中，再在需要的时候去处理这些消息。</strong></p> <p>可以通过在声明交换器（调用channel.exchangeDeclare方法）的时候添加alternate-exchange参数来实现，也可以通过策略（Policy，详细参考6.3节）的方式实现。如果两者同时使用，则前者的优先级更高，会覆盖掉Policy的设置。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/personal_wiki/book/rabbitmq-in-action-guide/03_客户端开发向导.html" class="prev">
        第三章 客户端开发向导
      </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/personal_wiki/assets/js/app.d60e7411.js" defer></script><script src="/personal_wiki/assets/js/2.487a0e24.js" defer></script><script src="/personal_wiki/assets/js/14.1e7cab5b.js" defer></script>
  </body>
</html>
